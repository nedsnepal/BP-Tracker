<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Monitor Reader - FCHV Survey</title>
    <!-- Use Tesseract.js v5 with correct API -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.6em;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: none;
        }
        
        .alert-error {
            background: #fee;
            color: #c33;
            border-left: 4px solid #c33;
        }
        
        .alert-success {
            background: #efe;
            color: #3c3;
            border-left: 4px solid #3c3;
        }
        
        .alert-info {
            background: #e6f3ff;
            color: #0066cc;
            border-left: 4px solid #0066cc;
            display: block;
        }
        
        .camera-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            display: none;
            margin: 0 auto 15px;
            border: 3px solid #667eea;
        }
        
        #canvas {
            display: none;
        }
        
        #captured-image {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin: 15px auto;
            display: none;
            border: 3px solid #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
            font-weight: 600;
            width: 90%;
            max-width: 300px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            background: #e8f4f8;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .bp-display {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .bp-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            min-width: 100px;
            margin: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .bp-label {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .bp-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .status-box {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .status-normal {
            background: #d4edda;
            color: #155724;
        }
        
        .status-high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-low {
            background: #fff3cd;
            color: #856404;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-box {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.8em;
            text-align: left;
            display: none;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .manual-entry {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .input-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü©∫ BP Monitor Reader</h1>
        <p class="subtitle">FCHV Survey Tool | Offline Compatible</p>
        
        <div class="alert alert-info" id="info-box">
            <strong>Tip:</strong> Ensure good lighting and hold phone steady. First OCR load may take 10-15 seconds.
        </div>
        
        <div class="alert alert-error" id="error-box"></div>
        <div class="alert alert-success" id="success-box"></div>

        <div class="camera-section">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <img id="captured-image" alt="Captured">
            
            <div id="camera-controls">
                <button class="btn" onclick="startCamera()">
                    üì∑ Open Camera
                </button>
            </div>
            
            <div id="capture-controls" style="display: none;">
                <button class="btn btn-success" onclick="capturePhoto()">
                    üì∏ Take Photo
                </button>
                <button class="btn btn-secondary" onclick="stopCamera()">
                    ‚ùå Cancel
                </button>
            </div>
            
            <div id="retake-controls" style="display: none;">
                <button class="btn" onclick="retakePhoto()">
                    üîÑ Retake
                </button>
                <button class="btn btn-success" onclick="processImage()" id="read-btn">
                    ‚úÖ Read BP Values
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing... Please wait</p>
                <p style="font-size: 0.8em; color: #666;">Loading OCR engine (one-time)</p>
            </div>
            
            <div class="debug-box" id="debug-box"></div>
        </div>

        <div class="result-section" id="result-section">
            <h3 style="text-align: center; margin-bottom: 15px;">üìä Results</h3>
            
            <div class="bp-display">
                <div class="bp-box">
                    <div class="bp-label">SYS (mmHg)</div>
                    <div class="bp-value" id="sys-value">--</div>
                </div>
                <div class="bp-box">
                    <div class="bp-label">DIA (mmHg)</div>
                    <div class="bp-value" id="dia-value">--</div>
                </div>
                <div class="bp-box">
                    <div class="bp-label">PULSE</div>
                    <div class="bp-value" id="pulse-value">--</div>
                </div>
            </div>

            <div class="status-box" id="status-box"></div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn" onclick="showManualEntry()" style="background: #e67e22;">
                    ‚úèÔ∏è Manual Entry
                </button>
                <button class="btn btn-success" onclick="saveReading()">
                    üíæ Save Record
                </button>
            </div>
        </div>

        <div class="manual-entry" id="manual-entry">
            <h4>Manual BP Entry</h4>
            <div class="input-row">
                <input type="number" id="manual-sys" placeholder="Systolic (e.g. 120)">
                <input type="number" id="manual-dia" placeholder="Diastolic (e.g. 80)">
            </div>
            <div class="input-row">
                <input type="number" id="manual-pulse" placeholder="Pulse (optional)">
            </div>
            <button class="btn btn-success" onclick="submitManual()" style="width: 100%;">
                Submit Values
            </button>
        </div>
    </div>

    <script>
        let stream = null;
        let currentImageData = null;
        let worker = null;
        let isProcessing = false;

        // Initialize worker on page load
        async function initWorker() {
            try {
                logDebug('Initializing Tesseract worker...');
                // Tesseract v5 API: createWorker(language)
                worker = await Tesseract.createWorker('eng');
                logDebug('Worker ready!');
                showSuccess('OCR engine loaded. Ready to scan.');
            } catch (err) {
                console.error('Worker init failed:', err);
                showError('OCR failed to load. Check internet connection.');
            }
        }

        // Start worker initialization
        initWorker();

        function logDebug(msg) {
            console.log(msg);
            const debugBox = document.getElementById('debug-box');
            debugBox.style.display = 'block';
            debugBox.innerHTML += msg + '<br>';
        }

        function showError(msg) {
            const box = document.getElementById('error-box');
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 5000);
        }

        function showSuccess(msg) {
            const box = document.getElementById('success-box');
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }

        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showError('Camera not supported in this browser');
                    return;
                }

                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.style.display = 'block';
                
                document.getElementById('camera-controls').style.display = 'none';
                document.getElementById('capture-controls').style.display = 'block';
                document.getElementById('captured-image').style.display = 'none';
                document.getElementById('result-section').style.display = 'none';
                
            } catch (err) {
                console.error('Camera error:', err);
                let msg = 'Camera error: ';
                if (err.name === 'NotAllowedError') msg += 'Permission denied';
                else if (err.name === 'NotFoundError') msg += 'No camera found';
                else msg += err.message;
                showError(msg);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('video').style.display = 'none';
            document.getElementById('camera-controls').style.display = 'block';
            document.getElementById('capture-controls').style.display = 'none';
            document.getElementById('retake-controls').style.display = 'none';
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            if (!video.videoWidth) {
                showError('Video not ready yet. Please wait.');
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Compress for mobile
            currentImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            document.getElementById('captured-image').src = currentImageData;
            document.getElementById('captured-image').style.display = 'block';
            document.getElementById('video').style.display = 'none';
            document.getElementById('capture-controls').style.display = 'none';
            document.getElementById('retake-controls').style.display = 'block';
            
            stopCamera();
        }

        function retakePhoto() {
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('debug-box').style.display = 'none';
            document.getElementById('debug-box').innerHTML = '';
            startCamera();
        }

        async function processImage() {
            if (!currentImageData) {
                showError('No image captured');
                return;
            }
            
            if (!worker) {
                showError('OCR not loaded yet. Please wait or refresh.');
                return;
            }
            
            if (isProcessing) return;
            isProcessing = true;
            
            const readBtn = document.getElementById('read-btn');
            readBtn.disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('retake-controls').style.display = 'none';
            
            try {
                logDebug('Starting OCR recognition...');
                
                // Tesseract v5 API
                const result = await worker.recognize(currentImageData);
                const text = result.data.text;
                
                logDebug('OCR Text: ' + text.replace(/\n/g, ' '));
                
                // Extract numbers
                const numbers = text.match(/\d+/g);
                logDebug('Found numbers: ' + (numbers ? numbers.join(', ') : 'none'));
                
                if (numbers && numbers.length >= 2) {
                    const nums = numbers.map(Number).filter(n => n >= 40 && n <= 300);
                    nums.sort((a, b) => b - a);
                    
                    if (nums.length >= 2) {
                        const sys = nums[0];
                        const dia = nums[1];
                        const pulse = nums[2] || '--';
                        
                        // Validate BP logic
                        if (sys > dia) {
                            displayResults(sys, dia, pulse);
                            showSuccess('BP values detected!');
                        } else {
                            throw new Error('Invalid BP values detected');
                        }
                    } else {
                        throw new Error('Could not find valid BP values');
                    }
                } else {
                    throw new Error('No numbers found in image');
                }
                
            } catch (error) {
                console.error('OCR Error:', error);
                logDebug('Error: ' + error.message);
                showError('OCR failed: ' + error.message + '. Try manual entry.');
                showManualEntry();
            } finally {
                document.getElementById('loading').style.display = 'none';
                readBtn.disabled = false;
                isProcessing = false;
            }
        }

        function displayResults(sys, dia, pulse) {
            document.getElementById('sys-value').textContent = sys;
            document.getElementById('dia-value').textContent = dia;
            document.getElementById('pulse-value').textContent = pulse;
            
            const statusBox = document.getElementById('status-box');
            
            // Simple BP classification
            if (sys >= 140 || dia >= 90) {
                statusBox.className = 'status-box status-high';
                statusBox.innerHTML = '‚ö†Ô∏è HIGH BP<br><small>Consult doctor</small>';
            } else if (sys <= 90 || dia <= 60) {
                statusBox.className = 'status-box status-low';
                statusBox.innerHTML = '‚ö†Ô∏è LOW BP<br><small>Take caution</small>';
            } else {
                statusBox.className = 'status-box status-normal';
                statusBox.innerHTML = '‚úÖ NORMAL BP';
            }
            
            document.getElementById('result-section').style.display = 'block';
            document.getElementById('retake-controls').style.display = 'block';
        }

        function showManualEntry() {
            document.getElementById('manual-entry').style.display = 'block';
        }

        function submitManual() {
            const sys = parseInt(document.getElementById('manual-sys').value);
            const dia = parseInt(document.getElementById('manual-dia').value);
            const pulse = document.getElementById('manual-pulse').value || '--';
            
            if (!sys || !dia) {
                showError('Please enter both systolic and diastolic values');
                return;
            }
            
            displayResults(sys, dia, pulse);
            document.getElementById('manual-entry').style.display = 'none';
            
            // Clear inputs
            document.getElementById('manual-sys').value = '';
            document.getElementById('manual-dia').value = '';
            document.getElementById('manual-pulse').value = '';
        }

        function saveReading() {
            const sys = document.getElementById('sys-value').textContent;
            const dia = document.getElementById('dia-value').textContent;
            const pulse = document.getElementById('pulse-value').textContent;
            const status = document.getElementById('status-box').textContent;
            
            const reading = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                sys, dia, pulse, status
            };
            
            // Get existing readings
            let readings = JSON.parse(localStorage.getItem('bpReadings') || '[]');
            readings.push(reading);
            localStorage.setItem('bpReadings', JSON.stringify(readings));
            
            showSuccess('Saved! Total records: ' + readings.length);
            
            // Reset
            setTimeout(() => {
                document.getElementById('result-section').style.display = 'none';
                document.getElementById('captured-image').style.display = 'none';
                document.getElementById('camera-controls').style.display = 'block';
                document.getElementById('retake-controls').style.display = 'none';
                document.getElementById('debug-box').style.display = 'none';
            }, 1500);
        }
    </script>
</body>
</html>
