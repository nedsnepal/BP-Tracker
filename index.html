<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Tracker - Simple Photo + Manual Entry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: #f0f2f5;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            background: #2c5aa0;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #2c5aa0;
            display: none;
        }
        
        .bp-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .bp-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .bp-box.active {
            border-color: #2c5aa0;
            background: #e3f2fd;
        }
        
        .bp-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .bp-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            display: none;
        }
        
        .status-high { background: #ffebee; color: #c62828; }
        .status-normal { background: #e8f5e9; color: #2e7d32; }
        .status-low { background: #fff3e0; color: #ef6c00; }
        
        .record-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #2c5aa0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hidden { display: none !important; }
        
        h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .helper-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>ü©∫ BP Tracker</h2>
        <p style="font-size: 14px; opacity: 0.9;">FCHV Survey Tool | Photo + Quick Entry</p>
    </div>

    <!-- STEP 1: Patient Info -->
    <div class="card" id="step1">
        <h3>Step 1: Patient Information</h3>
        <input type="text" id="patientId" placeholder="Patient ID (e.g. FCHV-001)">
        <input type="number" id="age" placeholder="Age (years)">
        <select id="gender">
            <option value="">Select Gender</option>
            <option value="F">Female</option>
            <option value="M">Male</option>
        </select>
        <input type="text" id="location" placeholder="Village/Ward">
        <button class="btn btn-success" onclick="goToStep2()">Next: Take Photo ‚Üí</button>
    </div>

    <!-- STEP 2: Photo -->
    <div class="card hidden" id="step2">
        <h3>Step 2: Photo of BP Monitor</h3>
        <p class="helper-text">Take a clear photo of the BP monitor screen showing the numbers</p>
        
        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
        
        <button class="btn" onclick="document.getElementById('camera-input').click()">
            üì∑ Take Photo
        </button>
        
        <img id="photo-preview" class="photo-preview">
        
        <div id="photo-buttons" class="hidden">
            <button class="btn btn-success" onclick="goToStep3()">Photo OK - Enter Values ‚Üí</button>
            <button class="btn btn-danger" onclick="retakePhoto()">Retake Photo</button>
        </div>
    </div>

    <!-- STEP 3: Enter BP Values -->
    <div class="card hidden" id="step3">
        <h3>Step 3: Enter BP Values</h3>
        <p class="helper-text">Look at the photo above and enter the numbers</p>
        
        <img id="reference-photo" class="photo-preview" style="display: block; max-height: 200px;">
        
        <div class="bp-inputs">
            <div class="bp-box">
                <div class="bp-label">SYS</div>
                <input type="number" id="sys" placeholder="120" style="margin: 0; text-align: center;">
            </div>
            <div class="bp-box">
                <div class="bp-label">DIA</div>
                <input type="number" id="dia" placeholder="80" style="margin: 0; text-align: center;">
            </div>
            <div class="bp-box">
                <div class="bp-label">PULSE</div>
                <input type="number" id="pulse" placeholder="72" style="margin: 0; text-align: center;">
            </div>
        </div>
        
        <div id="bp-status" class="status"></div>
        
        <button class="btn btn-success" onclick="calculateAndSave()">üíæ Save Record</button>
        <button class="btn btn-warning" onclick="goBack()">‚Üê Back</button>
    </div>

    <!-- STEP 4: Records List -->
    <div class="card" id="records-section">
        <h3>üìã Saved Records (<span id="record-count">0</span>)</h3>
        <div id="records-list"></div>
        <button class="btn" onclick="exportData()" style="margin-top: 10px;">
            üì• Export All Data (CSV)
        </button>
        <button class="btn btn-danger" onclick="clearAll()" style="margin-top: 10px;">
            üóëÔ∏è Clear All Data
        </button>
    </div>

    <script>
        let currentPhoto = null;
        let records = JSON.parse(localStorage.getItem('bpRecords') || '[]');
        
        // Load camera input handler
        document.getElementById('camera-input').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentPhoto = event.target.result;
                    document.getElementById('photo-preview').src = currentPhoto;
                    document.getElementById('photo-preview').style.display = 'block';
                    document.getElementById('photo-buttons').classList.remove('hidden');
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        
        function goToStep2() {
            if (!document.getElementById('patientId').value) {
                alert('Please enter Patient ID');
                return;
            }
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }
        
        function retakePhoto() {
            document.getElementById('camera-input').value = '';
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('photo-buttons').classList.add('hidden');
            currentPhoto = null;
        }
        
        function goToStep3() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('reference-photo').src = currentPhoto;
        }
        
        function goBack() {
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }
        
        function calculateAndSave() {
            const sys = parseInt(document.getElementById('sys').value);
            const dia = parseInt(document.getElementById('dia').value);
            const pulse = document.getElementById('pulse').value;
            
            if (!sys || !dia) {
                alert('Please enter both Systolic and Diastolic values');
                return;
            }
            
            // Calculate status
            let status, statusClass;
            if (sys >= 140 || dia >= 90) {
                status = 'HIGH BP - Refer to doctor';
                statusClass = 'status-high';
            } else if (sys <= 90 || dia <= 60) {
                status = 'LOW BP - Monitor closely';
                statusClass = 'status-low';
            } else {
                status = 'NORMAL BP';
                statusClass = 'status-normal';
            }
            
            // Show status
            const statusDiv = document.getElementById('bp-status');
            statusDiv.textContent = status;
            statusDiv.className = 'status ' + statusClass;
            statusDiv.style.display = 'block';
            
            // Save after short delay
            setTimeout(() => {
                const record = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    patientId: document.getElementById('patientId').value,
                    age: document.getElementById('age').value,
                    gender: document.getElementById('gender').value,
                    location: document.getElementById('location').value,
                    sys: sys,
                    dia: dia,
                    pulse: pulse || '-',
                    status: status,
                    photo: currentPhoto
                };
                
                records.push(record);
                localStorage.setItem('bpRecords', JSON.stringify(records));
                
                alert('‚úÖ Record saved successfully!');
                resetForm();
                updateRecordsList();
            }, 500);
        }
        
        function resetForm() {
            // Clear all inputs
            document.getElementById('patientId').value = '';
            document.getElementById('age').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('location').value = '';
            document.getElementById('sys').value = '';
            document.getElementById('dia').value = '';
            document.getElementById('pulse').value = '';
            document.getElementById('bp-status').style.display = 'none';
            
            // Reset photo
            retakePhoto();
            
            // Go back to step 1
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }
        
        function updateRecordsList() {
            document.getElementById('record-count').textContent = records.length;
            const list = document.getElementById('records-list');
            
            if (records.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center;">No records yet</p>';
                return;
            }
            
            list.innerHTML = records.slice().reverse().map(r => `
                <div class="record-item">
                    <div>
                        <strong>${r.patientId}</strong> - ${r.sys}/${r.dia} mmHg<br>
                        <small style="color: #666;">${r.date}</small>
                    </div>
                    <button onclick="deleteRecord(${r.id})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>
                </div>
            `).join('');
        }
        
        function deleteRecord(id) {
            if (confirm('Delete this record?')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('bpRecords', JSON.stringify(records));
                updateRecordsList();
            }
        }
        
        function exportData() {
            if (records.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csv = 'Date,Patient ID,Age,Gender,Location,Systolic,Diastolic,Pulse,Status\n';
            records.forEach(r => {
                csv += `"${r.date}","${r.patientId}","${r.age}","${r.gender}","${r.location}","${r.sys}","${r.dia}","${r.pulse}","${r.status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BP_Survey_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('üì• CSV file downloaded!');
        }
        
        function clearAll() {
            if (records.length === 0) return;
            if (confirm(`Delete all ${records.length} records? This cannot be undone!`)) {
                records = [];
                localStorage.removeItem('bpRecords');
                updateRecordsList();
                alert('All data cleared');
            }
        }
        
        // Initialize
        updateRecordsList();
    </script>
</body>
</html>
